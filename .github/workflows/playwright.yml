name: Playwright Tests E-Commerce

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      # --- 1Ô∏è‚É£ Checkout repo ---
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- 2Ô∏è‚É£ Setup Node.js ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # --- 3Ô∏è‚É£ Install dependencies ---
      - name: Install dependencies
        run: npm ci

      # --- 4Ô∏è‚É£ Install Playwright browsers ---
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      # --- 5Ô∏è‚É£ Start Mock API ---
      - name: Start Mock API (json-server)
        run: |
          nohup npm run mock-api > mock-api.log 2>&1 &
          echo "‚è≥ Waiting for mock API (http://localhost:5000)..."
          for i in {1..30}; do
            if curl -s http://localhost:5000 > /dev/null; then
              echo "‚úÖ Mock API ready!"
              break
            fi
            echo "‚è±Ô∏è Waiting ($i/30)..."
            sleep 1
          done

      # --- 6Ô∏è‚É£ Build SolidJS app ---
      - name: Build SolidJS project
        run: npm run build

      # --- 7Ô∏è‚É£ Start SolidJS preview server ---
      - name: Start SolidJS preview
        run: |
          nohup npm run serve > solid.log 2>&1 &
          echo "‚è≥ Waiting for Solid preview (http://localhost:5173)..."
          for i in {1..40}; do
            if curl -s http://localhost:5173 > /dev/null; then
              echo "‚úÖ Solid preview ready!"
              break
            fi
            echo "‚è±Ô∏è Waiting ($i/40)..."
            sleep 1
          done

      # --- 8Ô∏è‚É£ Jalankan Playwright Tests ---
      - name: Run Playwright tests
        run: npx playwright test

      # --- 9Ô∏è‚É£ Upload HTML report ---
      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/

      # --- üîü Upload log jika gagal ---
      - name: Upload logs if failed
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: server-logs
          path: |
            mock-api.log
            solid.log
